// Prisma schema for ContriVerse
// Database: NeonDB (serverless PostgreSQL)

generator client {
    provider             = "prisma-client-py"
    interface            = "asyncio"
    recursive_type_depth = 5
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_DATABASE_URL")
    // Connection URLs are now passed via PrismaClient constructor or environment variables
    // DATABASE_URL and DIRECT_DATABASE_URL will be used automatically
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
    id             String  @id @default(uuid())
    githubId       BigInt  @unique @map("github_id")
    githubUsername String  @map("github_username") @db.VarChar(255)
    avatarUrl      String? @map("avatar_url") @db.VarChar(512)
    profileUrl     String? @map("profile_url") @db.VarChar(512)
    email          String? @db.VarChar(255)

    // Account state
    isBanned  Boolean @default(false) @map("is_banned")
    isDeleted Boolean @default(false) @map("is_deleted")

    // Activity tracking
    lastLoginAt DateTime? @map("last_login_at")

    // Contribution metrics
    totalPoints Int  @default(0) @map("total_points")
    rank        Int?

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    refreshTokens      RefreshToken[]
    projectMaintainers ProjectMaintainer[]
    pullRequests       PullRequest[]
    prReviews          PRReview[]
    pointTransactions  PointTransaction[]
    userBadges         UserBadge[]
    auditLogs          AuditLog[]
    githubTokens       GitHubToken[]
    ownedProjects      Project[] // Projects where user is owner
    reviewComments     ReviewComment[]

    @@index([githubId])
    @@index([githubUsername])
    @@map("users")
}

model RefreshToken {
    id        String   @id @default(uuid())
    token     String   @unique @db.VarChar(512)
    userId    String   @map("user_id")
    expiresAt DateTime @map("expires_at")
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("refresh_tokens")
}

// ============================================================================
// PROJECTS & REPOSITORIES
// ============================================================================

model Project {
    id           String   @id @default(uuid())
    slug         String   @unique @db.VarChar(255) // URL-safe unique identifier
    name         String   @db.VarChar(255)
    description  String?  @db.Text
    tags         String[] // Array of tags (frontend, backend, ML, etc.)
    difficulty   String   @db.VarChar(50) // beginner, intermediate, advanced
    rules        Json? // Contribution rules as JSON
    rulesVersion Int      @default(1) @map("rules_version") // Rules version for non-retroactive changes
    ownerId      String   @map("owner_id") // Project owner (creator)
    isActive     Boolean  @default(true) @map("is_active")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    owner        User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
    maintainers  ProjectMaintainer[]
    repositories Repository[]

    @@unique([name]) // Enforce project name uniqueness
    @@index([slug])
    @@index([ownerId])
    @@index([isActive])
    @@map("projects")
}

model ProjectMaintainer {
    id        String @id @default(uuid())
    projectId String @map("project_id")
    userId    String @map("user_id")
    role      String @default("maintainer") @db.VarChar(50) // owner, maintainer

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([projectId, userId])
    @@index([projectId])
    @@index([userId])
    @@index([role])
    @@map("project_maintainers")
}

model Repository {
    id             String    @id @default(uuid())
    projectId      String    @map("project_id")
    githubRepoId   BigInt    @unique @map("github_repo_id")
    name           String    @db.VarChar(255)
    fullName       String    @map("full_name") @db.VarChar(255) // owner/repo
    defaultBranch  String    @default("main") @map("default_branch") @db.VarChar(100)
    isActive       Boolean   @default(true) @map("is_active")
    syncStatus     String    @default("synced") @map("sync_status") @db.VarChar(50) // synced, pending, failed
    lastSyncedAt   DateTime? @map("last_synced_at")
    disabledReason String?   @map("disabled_reason") @db.Text // Reason for disabling (deleted, private, etc.)

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
    pullRequests PullRequest[]

    @@index([projectId])
    @@index([githubRepoId])
    @@index([isActive])
    @@index([syncStatus])
    @@map("repositories")
}

// ============================================================================
// PULL REQUESTS & REVIEWS
// ============================================================================

model PullRequest {
    id           String @id @default(uuid())
    repositoryId String @map("repository_id")
    authorId     String @map("author_id")
    githubPrId   BigInt @unique @map("github_pr_id")
    prNumber     Int    @map("pr_number")
    title        String @db.VarChar(500)
    status       String @db.VarChar(50) // OPEN, UNDER_REVIEW, CHANGES_REQUESTED, APPROVED, MERGED, CLOSED
    score        Int    @default(0)

    // GitHub metadata
    githubUrl String @map("github_url") @db.VarChar(512)
    diffSize  Int?   @map("diff_size") // Lines changed

    // Lifecycle timestamps
    openedAt     DateTime  @map("opened_at")
    reviewedAt   DateTime? @map("reviewed_at") // When first review started
    approvedAt   DateTime? @map("approved_at") // When approved
    mergedAt     DateTime? @map("merged_at")
    closedAt     DateTime? @map("closed_at")
    lastSyncedAt DateTime? @map("last_synced_at") // Last sync from GitHub
    createdAt    DateTime  @default(now()) @map("created_at")
    updatedAt    DateTime  @updatedAt @map("updated_at")

    // Scoring metadata
    scoringMetadata Json? @map("scoring_metadata") // Scoring calculation details

    // Relations
    repository     Repository         @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
    author         User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
    reviews        PRReview[]
    transactions   PointTransaction[]
    reviewComments ReviewComment[]

    @@unique([repositoryId, prNumber])
    @@index([repositoryId])
    @@index([authorId])
    @@index([githubPrId])
    @@index([status])
    @@map("pull_requests")
}

model PRReview {
    id              String  @id @default(uuid())
    pullRequestId   String  @map("pull_request_id")
    reviewerId      String  @map("reviewer_id")
    action          String  @db.VarChar(50) // STARTED_REVIEW, REQUESTED_CHANGES, APPROVED, COMMENTED
    status          String  @db.VarChar(50) // PENDING, APPROVED, CHANGES_REQUESTED, REJECTED
    rating          Int? // 1-5 quality rating
    comment         String? @db.Text // Public comment
    internalComment String? @map("internal_comment") @db.Text // Platform-only comment
    isConflicting   Boolean @default(false) @map("is_conflicting") // Marks conflicting reviews
    resolvedBy      String? @map("resolved_by") // User ID who resolved conflict

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
    reviewer    User        @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

    @@index([pullRequestId])
    @@index([reviewerId])
    @@index([action])
    @@index([isConflicting])
    @@map("pr_reviews")
}

// ============================================================================
// SCORING & LEADERBOARD
// ============================================================================

model PointTransaction {
    id              String  @id @default(uuid())
    userId          String  @map("user_id")
    pullRequestId   String? @map("pull_request_id")
    points          Int // Can be positive or negative
    reason          String  @db.VarChar(255) // PR_OPENED, PR_MERGED, QUALITY_BONUS, SPAM_PENALTY
    transactionType String  @default("AWARD") @map("transaction_type") @db.VarChar(50) // AWARD, BONUS, PENALTY, REVERSAL
    metadata        Json? // Additional context

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    pullRequest PullRequest? @relation(fields: [pullRequestId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([pullRequestId])
    @@index([createdAt])
    @@index([transactionType])
    @@map("point_transactions")
}

// ============================================================================
// BADGES & ACHIEVEMENTS
// ============================================================================

model Badge {
    id          String  @id @default(uuid())
    name        String  @unique @db.VarChar(100)
    description String  @db.Text
    iconUrl     String? @map("icon_url") @db.VarChar(512)
    criteria    Json // Criteria for earning badge

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    userBadges UserBadge[]

    @@index([name])
    @@map("badges")
}

model UserBadge {
    id       String   @id @default(uuid())
    userId   String   @map("user_id")
    badgeId  String   @map("badge_id")
    earnedAt DateTime @default(now()) @map("earned_at")

    // Relations
    user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
    badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

    @@unique([userId, badgeId])
    @@index([userId])
    @@index([badgeId])
    @@map("user_badges")
}

// ============================================================================
// AUDIT & SECURITY
// ============================================================================

model AuditLog {
    id        String  @id @default(uuid())
    userId    String? @map("user_id")
    action    String  @db.VarChar(100) // USER_LOGIN, PR_CREATED, USER_BANNED, etc.
    entity    String? @db.VarChar(50) // user, project, pr, etc.
    entityId  String? @map("entity_id")
    metadata  Json? // Additional context
    ipAddress String? @map("ip_address") @db.VarChar(45)

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([action])
    @@index([createdAt])
    @@map("audit_logs")
}

// ============================================================================
// GITHUB INTEGRATION
// ============================================================================

model GitHubToken {
    id           String    @id @default(uuid())
    userId       String    @map("user_id")
    accessToken  String    @map("access_token") @db.VarChar(512) // Encrypted
    tokenType    String    @default("oauth") @map("token_type") @db.VarChar(50) // oauth, app
    scope        String?   @db.VarChar(255) // OAuth scopes
    expiresAt    DateTime? @map("expires_at") // For GitHub Apps
    isRevoked    Boolean   @default(false) @map("is_revoked")
    lastUsedAt   DateTime? @map("last_used_at")
    lastVerified DateTime? @map("last_verified")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, tokenType])
    @@index([userId])
    @@index([isRevoked])
    @@map("github_tokens")
}

model WebhookDelivery {
    id             String    @id @default(uuid())
    deliveryId     String    @unique @map("delivery_id") // GitHub delivery ID
    eventType      String    @map("event_type") @db.VarChar(50) // pull_request, push, repository
    action         String?   @db.VarChar(50) // opened, closed, etc.
    repositoryId   String?   @map("repository_id") @db.VarChar(255) // GitHub repo ID as string
    prId           String?   @map("pr_id") // Link to PullRequest if applicable
    fingerprint    String?   @unique @db.VarChar(255) // Unique event fingerprint for deduplication
    payload        Json // Full webhook payload
    processed      Boolean   @default(false)
    processedAt    DateTime? @map("processed_at")
    scoringApplied Boolean   @default(false) @map("scoring_applied") // Track if scoring was applied
    failureCount   Int       @default(0) @map("failure_count")
    lastError      String?   @map("last_error") @db.Text
    receivedAt     DateTime  @default(now()) @map("received_at")
    createdAt      DateTime  @default(now()) @map("created_at")

    @@index([deliveryId])
    @@index([eventType])
    @@index([processed])
    @@index([fingerprint])
    @@index([prId])
    @@map("webhook_deliveries")
}

// ============================================================================
// REVIEW SYSTEM
// ============================================================================

model ReviewComment {
    id            String  @id @default(uuid())
    pullRequestId String  @map("pull_request_id")
    reviewerId    String  @map("reviewer_id")
    comment       String  @db.Text
    isInternal    Boolean @default(true) @map("is_internal") // Platform-only comment

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
    reviewer    User        @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

    @@index([pullRequestId])
    @@index([reviewerId])
    @@map("review_comments")
}

model ReviewConflict {
    id                 String    @id @default(uuid())
    pullRequestId      String    @map("pull_request_id")
    conflictingReviews Json      @map("conflicting_reviews") // Array of review IDs
    resolutionMethod   String?   @map("resolution_method") @db.VarChar(50) // MAJORITY, OWNER_OVERRIDE, MANUAL
    finalOutcome       String?   @map("final_outcome") @db.VarChar(50) // APPROVED, CHANGES_REQUESTED
    resolvedBy         String?   @map("resolved_by") // User ID who resolved
    resolvedAt         DateTime? @map("resolved_at")
    isResolved         Boolean   @default(false) @map("is_resolved")

    // Timestamps
    createdAt DateTime @default(now()) @map("created_at")

    @@index([pullRequestId])
    @@index([isResolved])
    @@map("review_conflicts")
}
