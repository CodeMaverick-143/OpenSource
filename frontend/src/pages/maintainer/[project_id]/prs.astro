---
/**
 * Project PRs list page with filtering and sorting.
 */
import AppLayout from "../../../components/layout/AppLayout.astro";
import PRListItem from "../../../components/maintainer/PRListItem.astro";
import { getProjectPRs } from "../../../lib/api";
import type {
    PRStatus,
    ProjectPR,
    MaintainerFilters,
} from "../../../lib/types";

const { project_id } = Astro.params;

if (!project_id) {
    return Astro.redirect("/maintainer");
}

// Get query parameters
const url = new URL(Astro.request.url);
const statusFilter = url.searchParams.get("status") as PRStatus | null;
const sortBy = url.searchParams.get("sort_by") as
    | "newest"
    | "oldest"
    | "review_age"
    | null;
const page = parseInt(url.searchParams.get("page") || "1");

// Fetch PRs
let prs: ProjectPR[] = [];
let total: number = 0;
let totalPages: number = 0;
let error: string | null = null;

try {
    const filters: MaintainerFilters = { page, page_size: 20 };
    if (statusFilter) filters.status = statusFilter;
    if (sortBy) filters.sort_by = sortBy;

    const response = await getProjectPRs(project_id, filters);
    prs = response.prs;
    total = response.total;
    totalPages = response.total_pages;
} catch (e) {
    error = e instanceof Error ? e.message : "Failed to load PRs";
}

const statuses: PRStatus[] = [
    "OPEN",
    "UNDER_REVIEW",
    "CHANGES_REQUESTED",
    "APPROVED",
    "MERGED",
    "CLOSED",
];
const sortOptions = [
    { value: "newest", label: "Newest First" },
    { value: "oldest", label: "Oldest First" },
    { value: "review_age", label: "Needs Review" },
];
---

<AppLayout title="Project PRs">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-6">
            <a
                href="/maintainer"
                class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-4"
            >
                <svg
                    class="w-4 h-4 mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Dashboard
            </a>
            <h1 class="text-3xl font-bold text-gray-900">Pull Requests</h1>
        </div>

        <!-- Filters -->
        <div
            class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6"
        >
            <div class="flex flex-wrap gap-4">
                <!-- Status filter -->
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Status
                    </label>
                    <select
                        id="status-filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">All Statuses</option>
                        {
                            statuses.map((status) => (
                                <option
                                    value={status}
                                    selected={statusFilter === status}
                                >
                                    {status.replace(/_/g, " ")}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <!-- Sort filter -->
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Sort By
                    </label>
                    <select
                        id="sort-filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                    >
                        {
                            sortOptions.map((option) => (
                                <option
                                    value={option.value}
                                    selected={sortBy === option.value}
                                >
                                    {option.label}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <!-- Reset button -->
                <div class="flex items-end">
                    <a
                        href={`/maintainer/${project_id}/prs`}
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                    >
                        Reset
                    </a>
                </div>
            </div>
        </div>

        <!-- Error state -->
        {
            error && (
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-700">{error}</p>
                </div>
            )
        }

        <!-- PR count -->
        {
            !error && (
                <div class="mb-4 text-sm text-gray-600">
                    Showing {prs.length} of {total} PRs
                </div>
            )
        }

        <!-- PRs list -->
        {
            !error && prs.length === 0 ? (
                <div class="text-center py-12 bg-white rounded-lg border border-gray-200">
                    <p class="text-gray-500">No pull requests found</p>
                </div>
            ) : (
                <div class="space-y-4">
                    {prs.map((pr) => (
                        <PRListItem pr={pr} />
                    ))}
                </div>
            )
        }

        <!-- Pagination -->
        {
            !error && totalPages > 1 && (
                <div class="mt-6 flex justify-center gap-2">
                    {page > 1 && (
                        <a
                            href={`?page=${page - 1}${statusFilter ? `&status=${statusFilter}` : ""}${sortBy ? `&sort_by=${sortBy}` : ""}`}
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                        >
                            Previous
                        </a>
                    )}
                    <span class="px-4 py-2 text-sm text-gray-700">
                        Page {page} of {totalPages}
                    </span>
                    {page < totalPages && (
                        <a
                            href={`?page=${page + 1}${statusFilter ? `&status=${statusFilter}` : ""}${sortBy ? `&sort_by=${sortBy}` : ""}`}
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                        >
                            Next
                        </a>
                    )}
                </div>
            )
        }
    </div>
</AppLayout>

<script>
    // Handle filter changes
    const statusSelect = document.getElementById(
        "status-filter",
    ) as HTMLSelectElement;
    const sortSelect = document.getElementById(
        "sort-filter",
    ) as HTMLSelectElement;

    function updateFilters() {
        const params = new URLSearchParams();
        if (statusSelect.value) params.set("status", statusSelect.value);
        if (sortSelect.value) params.set("sort_by", sortSelect.value);

        const query = params.toString();
        const projectId = window.location.pathname.split("/")[2];
        window.location.href = `/maintainer/${projectId}/prs${query ? "?" + query : ""}`;
    }

    statusSelect?.addEventListener("change", updateFilters);
    sortSelect?.addEventListener("change", updateFilters);
</script>
