---
/**
 * Project analytics page showing contribution metrics and trends.
 */
import Layout from '../../../components/layout/AppLayout.astro';
import { getProjectAnalytics } from '../../../lib/api';

const { project_id } = Astro.params;

if (!project_id) {
    return Astro.redirect('/maintainer');
}

// Get time range from query params
const url = new URL(Astro.request.url);
const days = parseInt(url.searchParams.get('days') || '30');

// Fetch analytics
let analytics = null;
let error = null;

try {
    const response = await getProjectAnalytics(project_id, days);
    analytics = response.analytics;
} catch (e) {
    error = e instanceof Error ? e.message : 'Failed to load analytics';
}

const timeRanges = [
    { value: 7, label: '7 days' },
    { value: 30, label: '30 days' },
    { value: 90, label: '90 days' },
    { value: 365, label: '1 year' },
];
---

<Layout title="Project Analytics">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-6">
            <a
                href="/maintainer"
                class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-4"
            >
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Dashboard
            </a>
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Project Analytics</h1>

                <!-- Time range selector -->
                <select
                    id="time-range"
                    class="px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                >
                    {timeRanges.map(range => (
                        <option value={range.value} selected={days === range.value}>
                            {range.label}
                        </option>
                    ))}
                </select>
            </div>
        </div>

        <!-- Error state -->
        {error && (
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p class="text-red-700">{error}</p>
            </div>
        )}

        {!error && analytics && (
            <div class="space-y-6">
                <!-- Key metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Total PRs -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <div class="text-sm font-medium text-gray-600 mb-1">Total PRs</div>
                        <div class="text-3xl font-bold text-gray-900">{analytics.total_prs}</div>
                    </div>

                    <!-- Merged PRs -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <div class="text-sm font-medium text-gray-600 mb-1">Merged PRs</div>
                        <div class="text-3xl font-bold text-green-600">{analytics.merged_prs}</div>
                    </div>

                    <!-- Merge rate -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <div class="text-sm font-medium text-gray-600 mb-1">Merge Rate</div>
                        <div class="text-3xl font-bold text-blue-600">{analytics.pr_merge_rate}%</div>
                    </div>

                    <!-- Avg review time -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <div class="text-sm font-medium text-gray-600 mb-1">Avg Review Time</div>
                        <div class="text-3xl font-bold text-purple-600">
                            {analytics.avg_review_time_hours ? `${analytics.avg_review_time_hours}h` : 'N/A'}
                        </div>
                    </div>
                </div>

                <!-- Contribution volume chart -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Contribution Volume</h2>
                    {analytics.contribution_volume.length > 0 ? (
                        <div class="space-y-2">
                            {analytics.contribution_volume.map(item => (
                                <div class="flex items-center gap-3">
                                    <div class="text-sm text-gray-600 w-20">{item.week}</div>
                                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                                        <div
                                            class="bg-blue-500 h-full rounded-full flex items-center justify-end pr-2"
                                            style={`width: ${Math.min((item.count / Math.max(...analytics.contribution_volume.map((v: any) => v.count))) * 100, 100)}%`}
                                        >
                                            <span class="text-xs text-white font-medium">{item.count}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p class="text-gray-500 text-sm">No contribution data available</p>
                    )}
                </div>

                <!-- Top contributors -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Contributors</h2>
                    {analytics.top_contributors.length > 0 ? (
                        <div class="space-y-3">
                            {analytics.top_contributors.map((contributor, index) => (
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg font-bold text-gray-400">#{index + 1}</span>
                                        <span class="font-medium text-gray-900">{contributor.username}</span>
                                    </div>
                                    <span class="text-sm font-semibold text-blue-600">{contributor.count} PRs</span>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p class="text-gray-500 text-sm">No contributors yet</p>
                    )}
                </div>

                <!-- Quality trends -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Quality Trends (Rating Distribution)</h2>
                    <div class="space-y-2">
                        {[5, 4, 3, 2, 1].map(rating => {
                            const count = analytics.quality_trends[rating] || 0;
                            const total = Object.values(analytics.quality_trends).reduce((a: number, b: any) => a + b, 0) as number;
                            const percentage = total > 0 ? (count / total * 100) : 0;

                            return (
                                <div class="flex items-center gap-3">
                                    <div class="text-sm text-gray-600 w-16 flex items-center gap-1">
                                        <span>{rating}</span>
                                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                        </svg>
                                    </div>
                                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                                        <div
                                            class="bg-green-500 h-full rounded-full flex items-center justify-end pr-2"
                                            style={`width: ${percentage}%`}
                                        >
                                            {count > 0 && (
                                                <span class="text-xs text-white font-medium">{count}</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        )}
    </div>
</Layout>

<script>
    // Handle time range changes
    const timeRangeSelect = document.getElementById('time-range') as HTMLSelectElement;

    timeRangeSelect?.addEventListener('change', () => {
        const projectId = window.location.pathname.split('/')[2];
        window.location.href = `/maintainer/${projectId}/analytics?days=${timeRangeSelect.value}`;
    });
</script>
