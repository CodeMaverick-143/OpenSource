---
/**
 * Badges list page - displays all available badges with filtering.
 */
import AppLayout from "../../components/layout/AppLayout.astro";
import PublicBadgeGrid from "../../components/badges/PublicBadgeGrid.astro";
import { getAllBadges } from "../../lib/api";
import type { Badge, BadgeCategory, BadgeRarity } from "../../lib/types";
import BadgeGrid from "../../components/dashboard/BadgeGrid.astro";

// Get query parameters
const url = new URL(Astro.request.url);
const categoryFilter = url.searchParams.get("category") as BadgeCategory | null;
const rarityFilter = url.searchParams.get("rarity") as BadgeRarity | null;

// Fetch badges with filters
let badges: Badge[] = [];
let error = null;

try {
    const filters: any = {};
    if (categoryFilter) filters.category = categoryFilter;
    if (rarityFilter) filters.rarity = rarityFilter;

    const response = await getAllBadges(filters);
    badges = response.badges;
} catch (e) {
    error = e instanceof Error ? e.message : "Failed to load badges";
}

const categories: BadgeCategory[] = [
    "MILESTONE",
    "QUALITY",
    "STREAK",
    "SPECIAL",
];
const rarities: BadgeRarity[] = ["COMMON", "RARE", "EPIC", "LEGENDARY"];
---

<AppLayout title="Badges & Achievements">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                Badges & Achievements
            </h1>
            <p class="text-gray-600">
                Earn badges by contributing to projects and achieving milestones
            </p>
        </div>

        <!-- Filters -->
        <div
            class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6"
        >
            <div class="flex flex-wrap gap-4">
                <!-- Category filter -->
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Category
                    </label>
                    <select
                        id="category-filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">All Categories</option>
                        {
                            categories.map((cat) => (
                                <option
                                    value={cat}
                                    selected={categoryFilter === cat}
                                >
                                    {cat}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <!-- Rarity filter -->
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Rarity
                    </label>
                    <select
                        id="rarity-filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">All Rarities</option>
                        {
                            rarities.map((rarity) => (
                                <option
                                    value={rarity}
                                    selected={rarityFilter === rarity}
                                >
                                    {rarity}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <!-- Reset button -->
                <div class="flex items-end">
                    <a
                        href="/badges"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                    >
                        Reset
                    </a>
                </div>
            </div>
        </div>

        <!-- Error state -->
        {
            error && (
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-red-700">{error}</p>
                </div>
            )
        }

        <!-- Badge count -->
        {
            !error && (
                <div class="mb-4 text-sm text-gray-600">
                    Showing {badges.length}{" "}
                    {badges.length === 1 ? "badge" : "badges"}
                </div>
            )
        }

        <!-- Badges grid -->
        {!error && <PublicBadgeGrid badges={badges} />}
    </div>
</AppLayout>

<script>
    // Handle filter changes
    const categorySelect = document.getElementById(
        "category-filter",
    ) as HTMLSelectElement;
    const raritySelect = document.getElementById(
        "rarity-filter",
    ) as HTMLSelectElement;

    function updateFilters() {
        const params = new URLSearchParams();
        if (categorySelect.value) params.set("category", categorySelect.value);
        if (raritySelect.value) params.set("rarity", raritySelect.value);

        const query = params.toString();
        window.location.href = `/badges${query ? "?" + query : ""}`;
    }

    categorySelect?.addEventListener("change", updateFilters);
    raritySelect?.addEventListener("change", updateFilters);
</script>
